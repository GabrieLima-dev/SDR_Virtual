<!doctype html>
<html lang="pt-br" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DER e Estrutura do Banco ¬∑ SDR Virtual</title>
  <link rel="icon" href="../favicon.ico">
  <link rel="apple-touch-icon" href="../assets/img/favicon.png">
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@2.0.6/css/pico.min.css">
  <link rel="stylesheet" href="../assets/css/styles.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script defer src="../assets/js/app.js"></script>
</head>
<body class="fade-in">
<header class="container header">
  <nav>
    <ul>
      <li><img src="../assets/img/favicon.png" class="logo" alt="SDR"/><strong>SDR Virtual</strong></li>
    </ul>
    <ul>
      <li><a href="../index.html">In√≠cio</a></li>
      <li><a href="../sections/der-estrutura-banco.html">DER & Banco</a></li>
      <li><button id="themeToggle" aria-label="Alternar tema">üåó</button></li>
    </ul>
  </nav>
</header>
<main class="container grid">
  <aside class="sidebar">
    <input type="search" id="search" placeholder="Pesquisar..." aria-label="Pesquisar documenta√ß√£o" />
    <h6 class="muted">Cen√°rios</h6>
    <ul class="nav-list">
      <li><a href="../scenarios/recebe-mensagens.html">Recebe Mensagens</a></li>
      <li><a href="../scenarios/processamento-resposta.html">Processamento de Resposta</a></li>
      <li><a href="../scenarios/envio-resposta.html">Envio de Resposta</a></li>
      <li><a href="../scenarios/envio-fotos.html">Envio de Fotos</a></li>
      <li><a href="../scenarios/envio-arquivos.html">Envio de Arquivos</a></li>
      <li><a href="../scenarios/executor-de-filas.html">Executor de Filas</a></li>
      <li><a href="../scenarios/monitor-de-logs.html">Monitor de Logs</a></li>
      <li><a href="../scenarios/scheduler-cadencias.html">Scheduler de Cad√™ncias</a></li>
    </ul>
    <h6 class="muted">Arquitetura & Banco</h6>
    <ul class="nav-list">
      <li><a href="../sections/der-estrutura-banco.html">DER e Estrutura do Banco</a></li>
      <li><a href="../sections/config-postgresql.html">Configura√ß√£o do PostgreSQL</a></li>
      <li><a href="../sections/backup-retencao.html">Backup e Reten√ß√£o de Dados</a></li>
    </ul>
  </aside>
  <section class="content">

<hgroup>
  <h1>DER e Estrutura do Banco (PostgreSQL)</h1>
  <p class="muted">Documenta√ß√£o oficial das entidades, colunas e rela√ß√µes. Timestamps com <code>NOW()</code>; atualiza√ß√£o autom√°tica de <code>data_hora_ultima_alteracao</code> por trigger.</p>
</hgroup>

<article>
  <h2>DER Visual</h2>
  <div class="mermaid">
    erDiagram
      cliente ||--o{ contrato : possui
      produto ||--o{ plano : compoe
      plano ||--o{ contrato : define
      cliente ||--o{ cliente_configuracao : tem
      cliente ||--o{ sdr_cliente_config : controla
      cliente ||--o{ sdr_leads : atende
      sdr_situacao_interna ||--o{ sdr_leads : classifica
      canal ||--o{ sdr_leads : origina
      sdr_leads ||--o{ sdr_leads_historico : versiona
      sdr_leads ||--o{ sdr_mensagens : troca
      tipo_mensagem ||--o{ sdr_mensagens : tipa
      cliente ||--o{ sdr_contexto_cliente : contextualiza
      cliente ||--o{ sdr_produtos : oferta
      sdr_produtos ||--o{ sdr_imagem_produto : ilustra
      cliente ||--o{ sdr_bloqueio_atendimento : restringe
  </div>
</article>

<article>
  <h2>Conven√ß√µes</h2>
  <ul>
    <li>Nomes min√∫sculos com underscore.</li>
    <li><code>data_hora_cadastro TIMESTAMP DEFAULT NOW()</code> e <code>data_hora_ultima_alteracao TIMESTAMP DEFAULT NOW()</code>.</li>
    <li>Triggers de update para manter <code>data_hora_ultima_alteracao</code>.</li>
    <li>Booleans: <code>DEFAULT TRUE</code> quando fizer sentido.</li>
  </ul>
</article>

<hr>
<h2>N√∫cleo Comercial</h2>

<h3>cliente</h3>
<table>
<thead><tr><th>Coluna</th><th>Tipo</th><th>Descri√ß√£o</th></tr></thead>
<tbody>
<tr><td>id</td><td>SERIAL PK</td><td>Identificador</td></tr>
<tr><td>nome</td><td>TEXT</td><td>Nome do cliente/empresa</td></tr>
<tr><td>data_hora_cadastro</td><td>TIMESTAMP DEFAULT NOW()</td><td>Cria√ß√£o</td></tr>
<tr><td>data_hora_ultima_alteracao</td><td>TIMESTAMP DEFAULT NOW()</td><td>Atualizado por trigger</td></tr>
</tbody></table>

<h3>produto</h3>
<table>
<thead><tr><th>Coluna</th><th>Tipo</th><th>Descri√ß√£o</th></tr></thead>
<tbody>
<tr><td>id</td><td>SERIAL PK</td><td>Identificador</td></tr>
<tr><td>nome_produto</td><td>TEXT</td><td>Nome do produto</td></tr>
<tr><td>data_hora_cadastro</td><td>TIMESTAMP DEFAULT NOW()</td><td>Cria√ß√£o</td></tr>
<tr><td>data_hora_ultima_alteracao</td><td>TIMESTAMP DEFAULT NOW()</td><td>Atualizado por trigger</td></tr>
</tbody></table>

<h3>plano</h3>
<table>
<thead><tr><th>Coluna</th><th>Tipo</th><th>Descri√ß√£o</th></tr></thead>
<tbody>
<tr><td>id</td><td>SERIAL PK</td><td>Identificador</td></tr>
<tr><td>id_produto</td><td>INT FK ‚Üí produto(id)</td><td>Produto associado</td></tr>
<tr><td>descricao</td><td>TEXT</td><td>Descri√ß√£o do plano</td></tr>
<tr><td>limite</td><td>INT</td><td>Limite de uso</td></tr>
<tr><td>valor_mensal</td><td>NUMERIC(10,2)</td><td>Pre√ßo mensal</td></tr>
<tr><td>ativo</td><td>BOOLEAN DEFAULT TRUE</td><td>Status</td></tr>
<tr><td>data_hora_cadastro</td><td>TIMESTAMP DEFAULT NOW()</td><td>Cria√ß√£o</td></tr>
<tr><td>data_hora_ultima_alteracao</td><td>TIMESTAMP DEFAULT NOW()</td><td>Atualizado por trigger</td></tr>
</tbody></table>

<h3>contrato</h3>
<table>
<thead><tr><th>Coluna</th><th>Tipo</th><th>Descri√ß√£o</th></tr></thead>
<tbody>
<tr><td>id</td><td>SERIAL PK</td><td>Identificador</td></tr>
<tr><td>id_cliente</td><td>INT FK ‚Üí cliente(id)</td><td>Cliente</td></tr>
<tr><td>id_produto</td><td>INT FK ‚Üí produto(id)</td><td>Produto</td></tr>
<tr><td>id_plano</td><td>INT FK ‚Üí plano(id)</td><td>Plano</td></tr>
<tr><td>data_inicial</td><td>DATE</td><td>In√≠cio</td></tr>
<tr><td>data_final</td><td>DATE</td><td>T√©rmino</td></tr>
<tr><td>ativo</td><td>BOOLEAN DEFAULT TRUE</td><td>Status</td></tr>
<tr><td>data_hora_cadastro</td><td>TIMESTAMP DEFAULT NOW()</td><td>Cria√ß√£o</td></tr>
<tr><td>data_hora_ultima_alteracao</td><td>TIMESTAMP DEFAULT NOW()</td><td>Atualizado por trigger</td></tr>
</tbody></table>

<hr>
<h2>Configura√ß√µes & Ambiente</h2>

<h3>cliente_configuracao</h3>
<table>
<thead><tr><th>Coluna</th><th>Tipo</th><th>Descri√ß√£o</th></tr></thead>
<tbody>
<tr><td>id</td><td>SERIAL PK</td><td>Identificador</td></tr>
<tr><td>id_cliente</td><td>INT FK ‚Üí cliente(id)</td><td>Cliente</td></tr>
<tr><td>evol_api_key</td><td>TEXT</td><td>Chave Evolution</td></tr>
<tr><td>evol_phone_number</td><td>TEXT</td><td>N√∫mero WhatsApp</td></tr>
<tr><td>maritaca_api_key</td><td>TEXT</td><td>Chave Maritaca</td></tr>
<tr><td>fuso_horario</td><td>TEXT</td><td>Ex.: America/Maceio</td></tr>
<tr><td>data_hora_cadastro</td><td>TIMESTAMP DEFAULT NOW()</td><td>Cria√ß√£o</td></tr>
<tr><td>data_hora_ultima_alteracao</td><td>TIMESTAMP DEFAULT NOW()</td><td>Atualizado por trigger</td></tr>
</tbody></table>

<h3>sdr_cliente_config</h3>
<table>
<thead><tr><th>Coluna</th><th>Tipo</th><th>Descri√ß√£o</th></tr></thead>
<tbody>
<tr><td>id</td><td>SERIAL PK</td><td>Identificador</td></tr>
<tr><td>id_cliente</td><td>INT FK ‚Üí cliente(id)</td><td>Cliente</td></tr>
<tr><td>limite_followups</td><td>INT</td><td>M√°ximo de follow-ups</td></tr>
<tr><td>intervalo_followup</td><td>INT</td><td>Intervalo (min)</td></tr>
<tr><td>janela_envio</td><td>VARCHAR(20)</td><td>HH:MM-HH:MM</td></tr>
<tr><td>anti_spam_ativo</td><td>BOOLEAN DEFAULT TRUE</td><td>Jitter/pacing</td></tr>
<tr><td>data_hora_cadastro</td><td>TIMESTAMP DEFAULT NOW()</td><td>Cria√ß√£o</td></tr>
<tr><td>data_hora_ultima_alteracao</td><td>TIMESTAMP DEFAULT NOW()</td><td>Atualizado por trigger</td></tr>
</tbody></table>

<hr>
<h2>Operacional</h2>

<h3>canal</h3>
<table><thead><tr><th>Coluna</th><th>Tipo</th><th>Descri√ß√£o</th></tr></thead><tbody>
<tr><td>id</td><td>SERIAL PK</td><td>Identificador</td></tr>
<tr><td>nome</td><td>TEXT</td><td>WhatsApp, Site...</td></tr>
<tr><td>ativo</td><td>BOOLEAN DEFAULT TRUE</td><td>Status</td></tr>
<tr><td>data_hora_cadastro</td><td>TIMESTAMP DEFAULT NOW()</td><td>Cria√ß√£o</td></tr>
<tr><td>data_hora_ultima_alteracao</td><td>TIMESTAMP DEFAULT NOW()</td><td>Atualizado por trigger</td></tr>
</tbody></table>

<h3>sdr_situacao_interna</h3>
<table><thead><tr><th>Coluna</th><th>Tipo</th><th>Descri√ß√£o</th></tr></thead><tbody>
<tr><td>id</td><td>SERIAL PK</td><td>Identificador</td></tr>
<tr><td>nome</td><td>TEXT</td><td>Situa√ß√£o do lead</td></tr>
<tr><td>data_hora_cadastro</td><td>TIMESTAMP DEFAULT NOW()</td><td>Cria√ß√£o</td></tr>
<tr><td>data_hora_ultima_alteracao</td><td>TIMESTAMP DEFAULT NOW()</td><td>Atualizado por trigger</td></tr>
</tbody></table>

<h3>sdr_leads</h3>
<table><thead><tr><th>Coluna</th><th>Tipo</th><th>Descri√ß√£o</th></tr></thead><tbody>
<tr><td>id</td><td>SERIAL PK</td><td>Identificador</td></tr>
<tr><td>id_cliente</td><td>INT FK ‚Üí cliente(id)</td><td>Cliente dono</td></tr>
<tr><td>id_lead</td><td>TEXT</td><td>ID CRM</td></tr>
<tr><td>whatsapp_id</td><td>TEXT</td><td>N√∫mero do lead</td></tr>
<tr><td>id_situacao_interna</td><td>INT FK ‚Üí sdr_situacao_interna(id)</td><td>Status atual</td></tr>
<tr><td>tentativas_contato</td><td>INT DEFAULT 0</td><td>Tentativas</td></tr>
<tr><td>canal</td><td>INT FK ‚Üí canal(id)</td><td>Origem</td></tr>
<tr><td>data_hora_cadastro</td><td>TIMESTAMP DEFAULT NOW()</td><td>Cria√ß√£o</td></tr>
<tr><td>data_hora_ultima_alteracao</td><td>TIMESTAMP DEFAULT NOW()</td><td>Trigger</td></tr>
</tbody></table>

<h3>sdr_leads_historico</h3>
<table><thead><tr><th>Coluna</th><th>Tipo</th><th>Descri√ß√£o</th></tr></thead><tbody>
<tr><td>id</td><td>SERIAL PK</td><td>Identificador</td></tr>
<tr><td>id_cliente</td><td>INT FK ‚Üí cliente(id)</td><td>Cliente</td></tr>
<tr><td>id_lead</td><td>INT FK ‚Üí sdr_leads(id)</td><td>Lead</td></tr>
<tr><td>id_situacao_interna_anterior</td><td>INT FK ‚Üí sdr_situacao_interna(id)</td><td>Anterior</td></tr>
<tr><td>id_situacao_interna_nova</td><td>INT FK ‚Üí sdr_situacao_interna(id)</td><td>Nova</td></tr>
<tr><td>data_hora_cadastro</td><td>TIMESTAMP DEFAULT NOW()</td><td>Quando</td></tr>
</tbody></table>

<h3>tipo_mensagem</h3>
<table><thead><tr><th>Coluna</th><th>Tipo</th><th>Descri√ß√£o</th></tr></thead><tbody>
<tr><td>id</td><td>SERIAL PK</td><td>Identificador</td></tr>
<tr><td>nome</td><td>TEXT</td><td>Texto, Imagem, Documento, √Åudio...</td></tr>
<tr><td>descricao</td><td>TEXT</td><td>Detalhes</td></tr>
<tr><td>ativo</td><td>BOOLEAN DEFAULT TRUE</td><td>Status</td></tr>
<tr><td>data_hora_cadastro</td><td>TIMESTAMP DEFAULT NOW()</td><td>Cria√ß√£o</td></tr>
<tr><td>data_hora_ultima_alteracao</td><td>TIMESTAMP DEFAULT NOW()</td><td>Trigger</td></tr>
</tbody></table>

<h3>sdr_mensagens</h3>
<table><thead><tr><th>Coluna</th><th>Tipo</th><th>Descri√ß√£o</th></tr></thead><tbody>
<tr><td>id</td><td>SERIAL PK</td><td>Identificador</td></tr>
<tr><td>id_cliente</td><td>INT FK ‚Üí cliente(id)</td><td>Cliente</td></tr>
<tr><td>id_lead</td><td>INT FK ‚Üí sdr_leads(id)</td><td>Lead</td></tr>
<tr><td>whatsapp_id</td><td>TEXT</td><td>ID √∫nico da mensagem</td></tr>
<tr><td>whatsapp_name</td><td>TEXT</td><td>Nome do remetente</td></tr>
<tr><td>role</td><td>TEXT</td><td>user | assistant | system</td></tr>
<tr><td>texto</td><td>TEXT</td><td>Conte√∫do</td></tr>
<tr><td>tipo_mensagem</td><td>INT FK ‚Üí tipo_mensagem(id)</td><td>Tipo</td></tr>
<tr><td>data_hora_cadastro</td><td>TIMESTAMP DEFAULT NOW()</td><td>Momento</td></tr>
<tr><td>data_hora_ultima_alteracao</td><td>TIMESTAMP DEFAULT NOW()</td><td>Trigger</td></tr>
</tbody></table>

<hr>
<h2>Contextos e Produtos</h2>

<h3>sdr_contexto_cliente</h3>
<p><strong>contexto_base</strong> = tom de voz, pol√≠ticas e instru√ß√µes. <strong>contexto_institucional</strong> = conhecimento geral da empresa.</p>
<table><thead><tr><th>Coluna</th><th>Tipo</th><th>Descri√ß√£o</th></tr></thead><tbody>
<tr><td>id</td><td>SERIAL PK</td><td>Identificador</td></tr>
<tr><td>id_cliente</td><td>INT FK ‚Üí cliente(id)</td><td>Cliente</td></tr>
<tr><td>contexto_base</td><td>TEXT</td><td>Tom de voz, pol√≠ticas e instru√ß√µes</td></tr>
<tr><td>contexto_institucional</td><td>TEXT</td><td>Conhecimento geral</td></tr>
<tr><td>ativo</td><td>BOOLEAN DEFAULT TRUE</td><td>Status</td></tr>
<tr><td>data_hora_cadastro</td><td>TIMESTAMP DEFAULT NOW()</td><td>Cria√ß√£o</td></tr>
<tr><td>data_hora_ultima_alteracao</td><td>TIMESTAMP DEFAULT NOW()</td><td>Trigger</td></tr>
</tbody></table>

<h3>sdr_produtos</h3>
<table><thead><tr><th>Coluna</th><th>Tipo</th><th>Descri√ß√£o</th></tr></thead><tbody>
<tr><td>id</td><td>SERIAL PK</td><td>Identificador</td></tr>
<tr><td>id_cliente</td><td>INT FK ‚Üí cliente(id)</td><td>Cliente</td></tr>
<tr><td>nome</td><td>TEXT</td><td>Nome do produto</td></tr>
<tr><td>contexto_produto</td><td>TEXT</td><td>Conte√∫do sobre o produto</td></tr>
<tr><td>ativo</td><td>BOOLEAN DEFAULT TRUE</td><td>Status</td></tr>
<tr><td>data_hora_cadastro</td><td>TIMESTAMP DEFAULT NOW()</td><td>Cria√ß√£o</td></tr>
<tr><td>data_hora_ultima_alteracao</td><td>TIMESTAMP DEFAULT NOW()</td><td>Trigger</td></tr>
</tbody></table>

<h3>sdr_imagem_produto</h3>
<table><thead><tr><th>Coluna</th><th>Tipo</th><th>Descri√ß√£o</th></tr></thead><tbody>
<tr><td>id</td><td>SERIAL PK</td><td>Identificador</td></tr>
<tr><td>id_cliente</td><td>INT FK ‚Üí cliente(id)</td><td>Cliente</td></tr>
<tr><td>id_produto</td><td>INT FK ‚Üí sdr_produtos(id)</td><td>Produto</td></tr>
<tr><td>nome</td><td>TEXT</td><td>T√≠tulo</td></tr>
<tr><td>descricao</td><td>TEXT</td><td>Descri√ß√£o</td></tr>
<tr><td>url_download</td><td>TEXT</td><td>Download</td></tr>
<tr><td>url_view</td><td>TEXT</td><td>Visualiza√ß√£o</td></tr>
<tr><td>ativo</td><td>BOOLEAN DEFAULT TRUE</td><td>Status</td></tr>
<tr><td>data_hora_cadastro</td><td>TIMESTAMP DEFAULT NOW()</td><td>Cria√ß√£o</td></tr>
<tr><td>data_hora_ultima_alteracao</td><td>TIMESTAMP DEFAULT NOW()</td><td>Trigger</td></tr>
</tbody></table>

<hr>
<h2>Controle de Atendimento</h2>

<h3>sdr_bloqueio_atendimento</h3>
<table><thead><tr><th>Coluna</th><th>Tipo</th><th>Descri√ß√£o</th></tr></thead><tbody>
<tr><td>id</td><td>SERIAL PK</td><td>Identificador</td></tr>
<tr><td>id_cliente</td><td>INT FK ‚Üí cliente(id)</td><td>Cliente</td></tr>
<tr><td>whatsapp_id</td><td>TEXT</td><td>N√∫mero do contato</td></tr>
<tr><td>whatsapp_name</td><td>TEXT</td><td>Nome</td></tr>
<tr><td>id_lead</td><td>INT FK ‚Üí sdr_leads(id)</td><td>Lead rel.</td></tr>
<tr><td>descricao</td><td>TEXT</td><td>Motivo</td></tr>
<tr><td>ativo</td><td>BOOLEAN DEFAULT TRUE</td><td>Status</td></tr>
<tr><td>data_hora_cadastro</td><td>TIMESTAMP DEFAULT NOW()</td><td>Cria√ß√£o</td></tr>
<tr><td>data_hora_ultima_alteracao</td><td>TIMESTAMP DEFAULT NOW()</td><td>Trigger</td></tr>
</tbody></table>

<hr>
<h2>Tabelas com Hist√≥rico (Auditoria Autom√°tica)</h2>

<h3>Lista</h3>
<table>
<thead><tr><th>Tabela principal</th><th>Tabela hist√≥rico</th><th>Motivo</th></tr></thead>
<tbody>
<tr><td>sdr_contexto_cliente</td><td>sdr_contexto_cliente_historico</td><td>Contextos da IA</td></tr>
<tr><td>sdr_cliente_config</td><td>sdr_cliente_config_historico</td><td>Flags e limites</td></tr>
<tr><td>cliente_configuracao</td><td>cliente_configuracao_historico</td><td>Tokens e integra√ß√µes</td></tr>
<tr><td>sdr_produtos</td><td>sdr_produtos_historico</td><td>Conte√∫do de produtos</td></tr>
<tr><td>sdr_imagem_produto</td><td>sdr_imagem_produto_historico</td><td>URLs e metadados</td></tr>
<tr><td>sdr_leads</td><td>sdr_leads_historico</td><td>Status e dados do lead</td></tr>
</tbody>
</table>

<p><em>Formato de hist√≥rico</em>: <code>id</code>, <code>id_registro</code>, <code>campo_alterado</code>, <code>valor_anterior</code>, <code>valor_novo</code>, <code>alterado_por</code>, <code>host</code>, <code>aplicacao</code>, <code>data_hora_cadastro DEFAULT NOW()</code>.</p>


  </section>
</main>
<footer class="container">
  <small>¬© 2025 SDR Virtual ¬∑ Documenta√ß√£o.</small>
</footer>
</body>
</html>
